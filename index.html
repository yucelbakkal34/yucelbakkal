<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YÃ¼cel Bakkal POS Sistemi - Veresiye (V.D.) SÃ¼rÃ¼mÃ¼</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    /* GENEL STÄ°LLER */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f0f2f5; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
    .top-menu { background:#fff; border-bottom:1px solid #e0e0e0; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    .top-menu a { text-decoration:none; color:#333; margin-right:15px; font-weight:500; cursor:pointer; }
    .destek { color:#6c757d; font-size:.9em; }

    /* MODÃœL ALANLARI */
    .content-area { flex:1; overflow-y:auto; display:none; }
    #anasayfa-modulu { display:flex; flex-direction:row; }

    .modul-container { padding:40px 20px; display:flex; flex-wrap:wrap; gap:20px; }
    .modul-btn { width:150px; height:150px; border-radius:8px; color:white; padding:15px; text-align:center; cursor:pointer; transition:transform .2s, box-shadow .2s; box-shadow:0 4px 6px rgba(0,0,0,.1); display:flex; flex-direction:column; justify-content:center; }
    .modul-btn:hover { transform:translateY(-5px); box-shadow:0 8px 15px rgba(0,0,0,.2); }
    .modul-btn i { font-size:40px; margin-bottom:10px; display:block; }
    .modul-btn p { margin:0; font-size:14px; font-weight:bold; }
    .modul-btn span { display:block; font-size:11px; opacity:.8; margin-top:5px; }
    .bg-blue{background:#3b5998} .bg-orange{background:#ff8c00} .bg-green{background:#4CAF50} .bg-purple{background:#9370db} .bg-yellow{background:#ffc107;color:#333} .bg-red{background:#dc3545} .bg-lightblue{background:#00bcd4} .bg-darkblue{background:#2196f3} .bg-navy{background:#001f3f}

    /* SATIÅ & STOK */
    #satis-modulu, #stok-modulu, #rapor-modulu, #cari-modulu { display:flex; flex-direction:column; height:100%; }
    .top-bar-satis { background:#001f3f; color:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; font-size:1.1em; }
    .top-bar-satis .total-price { font-size:2em; font-weight:bold; color:#ffc107; }
    .main-work-area { display:flex; flex:1; overflow:hidden; background:#fff; }

    /* SatÄ±ÅŸ sol panel */
    .left-panel { width:260px; min-width:260px; padding:15px; background:#fff; border-right:1px solid #ddd; display:flex; flex-direction:column; }
    .input-group { margin-bottom:15px; }
    .input-group label { display:block; font-size:.9em; margin-bottom:5px; font-weight:bold; }
    .input-group input, .input-group select { width:100%; padding:8px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
    .payment-options label { margin-right:10px; font-weight:normal!important; }
    .action-btn { width:100%; padding:12px 10px; margin-bottom:10px; border:none; border-radius:4px; color:#fff; font-weight:bold; font-size:1em; cursor:pointer; display:flex; align-items:center; justify-content:flex-start; }
    .action-btn i { margin-right:10px; font-size:1.1em; }
    .btn-sales{background:#4CAF50} .btn-return{background:#00bcd4} .btn-discount{background:#ff9800} .btn-lookup{background:#9e9e9e}

    /* Sepet alanÄ± */
    .center-panel { flex:1; display:flex; flex-direction:column; overflow:hidden; }
    .cart-header { background:#e3f2fd; padding:10px; font-weight:bold; display:flex; border-bottom:2px solid #ccc; }
    .col-urun{flex:5} .col-miktar,.col-kdv,.col-tutar{flex:1.5;text-align:right} .col-bfiyat{flex:2;text-align:right} .col-stok{flex:1.5;text-align:center}
    .cart-items { flex:1; overflow-y:auto; }
    .cart-row { display:flex; padding:8px 10px; border-bottom:1px dashed #eee; cursor:pointer; align-items:center; }
    .bottom-panel { min-height:120px; background:#fff; border-top:1px solid #ddd; padding:10px; overflow-x:auto; white-space:nowrap; }
    .quick-sale-btn { display:inline-block; width:110px; height:90px; margin-right:10px; background:#007bff; color:#fff; border:none; border-radius:4px; padding:6px; text-align:center; font-size:.8em; font-weight:600; cursor:pointer; vertical-align:top; }

    /* Stok */
    #stok-modulu .main-work-area { flex-direction:column; padding:20px; }
    #stok-modulu table { width:100%; border-collapse:collapse; margin-top:10px; }
    #stok-modulu th, #stok-modulu td { padding:12px; border:1px solid #ddd; text-align:left; }
    #stok-modulu th { background:#f2f2f2; }

    /* Raporlar */
    #rapor-modulu .filters { display:grid; grid-template-columns:repeat(6, minmax(0,1fr)); gap:10px; padding:15px; }
    #rapor-modulu .box { background:#fff; margin:10px; border:1px solid #e5e5e5; border-radius:8px; overflow:hidden; }
    #rapor-modulu table { width:100%; border-collapse:collapse; }
    #rapor-modulu th, #rapor-modulu td { padding:10px; border-bottom:1px solid #eee; }
    #rapor-modulu th { background:#f8f9fa; text-align:left; font-size:.9em; }
    .totals { display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:10px; padding:10px; }
    .totals .kpi { background:#fff; border:1px solid #e5e5e5; border-radius:8px; padding:12px; }

    /* Basit modal (genel) */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); }
    .modal .panel { background:#fff; border-radius:10px; padding:16px; width:520px; max-width:95vw; }
    .modal .row { margin-bottom:10px; }
    .modal .row label { display:block; font-size:.85em; margin-bottom:4px; font-weight:600; }
    .modal .row input, .modal .row select { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
    .right { text-align:right }

    /* Stok gÃ¶rÃ¼ntÃ¼leme modalÄ± */
    .panel.wide { width:1000px; max-width:96vw; }
    .table-like{max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:8px;background:#fff}
    .table-like table{width:100%;border-collapse:collapse}
    .table-like th,.table-like td{border-bottom:1px solid #f0f0f0;padding:8px;text-align:left;font-size:.95em;vertical-align:middle}
    .table-like th{background:#fafafa;position:sticky;top:0;z-index:1}
    .inline-input{width:100%;box-sizing:border-box;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
    .toolbar { display:flex; gap:10px; justify-content:flex-end; align-items:center; }

    /* KÃ¼Ã§Ã¼k buton stili */
    .btn-outline { background:#fff; border:1px solid #0d6efd; color:#0d6efd; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn-outline:hover { background:#0d6efd; color:#fff; }
    .btn-muted { background:#6c757d; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn-save { background:#4CAF50; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }

    /* Ayarlar modalÄ± */
    .settings-title{font-size:1.15em;margin:4px 0 10px}
    .danger{background:#dc3545;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .warn{background:#ff9800;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .safe{background:#4CAF50;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .row-info{background:#fff7e6;border:1px solid #ffe0a3;padding:10px;border-radius:8px;color:#8a6d3b}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .text-sm{font-size:.9em;color:#555}
  </style>
</head>
<body>
  <div class="top-menu">
    <div>
      <a onclick="showModule('anasayfa')">Ana Sayfa</a>
      <a onclick="showModule('satis')">MenÃ¼</a>
      <a onclick="showModule('stok')">Ä°ÅŸlemler</a>
      <a onclick="openSettings()">Ayarlar</a>
      <a id="lnk-export">Yedek Al</a>
      <a id="lnk-import">Ä°Ã§e Aktar</a>
      <input id="file-import" type="file" accept="application/json" style="display:none">
    </div>
    <div class="destek"><b>YÃ¼cel Bakkal</b></div>
  </div>

  <!-- ANA SAYFA -->
  <div id="anasayfa-modulu" class="content-area" style="display:flex;">
    <div class="modul-container">
      <div class="modul-btn bg-blue" onclick="showModule('satis')"><i class="fa-solid fa-cart-shopping"></i><p>SatÄ±ÅŸ EkranÄ±</p><span>[F1]</span></div>
      <div class="modul-btn bg-orange" onclick="showModule('stok')"><i class="fa-solid fa-boxes-stacked"></i><p>Stok EkranÄ±</p><span>[F2]</span></div>
      <div class="modul-btn bg-green" onclick="showModule('rapor')"><i class="fa-solid fa-chart-line"></i><p>Raporlar</p><span>[F3]</span></div>

      <!-- Ã–nceki "Cari" butonu aynÄ±, aÅŸaÄŸÄ±da V.D. ayrÄ± kutu -->
      <div class="modul-btn bg-purple" onclick="showModule('cari')"><i class="fa-solid fa-user-group"></i><p>V.D.</p><span>Veresiye Defteri</span></div>

      <!-- Ã–nce "Ä°ÅŸ RaporlarÄ±" idi â†’ V.D. / Veresiye Defteri -->
      <div class="modul-btn bg-yellow" onclick="showModule('cari')">
        <i class="fa-solid fa-file-invoice-dollar" style="color:#333"></i>
        <p style="color:#333">V.D.</p><span>Veresiye Defteri</span>
      </div>

      <div class="modul-btn bg-red" onclick="alert('Fatura modÃ¼lÃ¼ demo sÃ¼rÃ¼mde deÄŸil.')"><i class="fa-solid fa-file-lines"></i><p>Faturalar</p><span>[F6]</span></div>
      <div class="modul-btn bg-lightblue" onclick="alert('Toplu fiyat geÃ§iÅŸi demo olarak devre dÄ±ÅŸÄ±.')"><i class="fa-solid fa-tags"></i><p>Toplu Fiyat GeÃ§iÅŸi</p><span>[F7]</span></div>
      <div class="modul-btn bg-darkblue" onclick="alert('Online zam geÃ§iÅŸi demo olarak devre dÄ±ÅŸÄ±.')"><i class="fa-solid fa-globe"></i><p>Online Zam GeÃ§iÅŸi</p><span>[F8]</span></div>
      <div class="modul-btn bg-navy" onclick="alert('Kredi fÄ±rsatlarÄ± demo.')"><i class="fa-solid fa-credit-card"></i><p>Sana Ã–zel Kredi</p></div>
    </div>
  </div>

  <!-- SATIÅ MODÃœLÃœ -->
  <div id="satis-modulu" class="content-area">
    <div class="top-bar-satis">
      <span>1. SatÄ±ÅŸ EkranÄ± | Barkod okut â€“ Ã§ift tÄ±kla dÃ¼zenle</span>
      <div>Toplam Tutar: <span class="total-price" id="genel-toplam">0,00 â‚º</span></div>
    </div>
    <div class="main-work-area">
      <div class="left-panel">
        <div class="input-group"><label for="barkod-input">Barkod</label><input type="text" id="barkod-input" placeholder="Barkodu yaz/okut ve Enter" onkeypress="handleBarcodeEnter(event)"></div>
        <div class="input-group"><label for="musteri-select">MÃ¼ÅŸteri</label><select id="musteri-select"><option value="">Perakende SatÄ±ÅŸ</option></select></div>
        <div class="input-group"><label for="depo-select">Depo</label><select id="depo-select"><option value="merkez">Merkez Depo</option></select></div>
        <div class="input-group"><label>Ã–deme Åekli</label><div class="payment-options">
          <input type="radio" id="odemeNakit" name="odeme" value="nakit" checked><label for="odemeNakit">Nakit</label>
          <input type="radio" id="odemeKredi" name="odeme" value="kart"><label for="odemeKredi">Kart</label>
          <!-- GÃ¶rÃ¼nen isim Veresiye (V.D.), value aynÄ± (cari) -->
          <input type="radio" id="odemeCari" name="odeme" value="cari"><label for="odemeCari">Veresiye (V.D.)</label>
        </div></div>
        <hr style="border-top:1px solid #eee; margin:10px 0;">
        <button class="action-btn btn-sales" onclick="satisYap()"><i class="fa-solid fa-check"></i> SatÄ±ÅŸ Yap [F1]</button>
        <button class="action-btn btn-return" onclick="iadeIslemi()"><i class="fa-solid fa-arrow-left"></i> Ä°ade [F3]</button>
        <button class="action-btn btn-discount" onclick="indirimUygula()"><i class="fa-solid fa-percent"></i> Ä°ndirim [F4]</button>
        <button class="action-btn btn-lookup" onclick="fiyatGor()"><i class="fa-solid fa-magnifying-glass"></i> Fiyat GÃ¶r [F7]</button>
      </div>
      <div class="center-panel">
        <div class="cart-header">
          <span class="col-urun"># ÃœRÃœN ADI</span>
          <span class="col-miktar">MÄ°KTAR</span>
          <span class="col-bfiyat">B. FÄ°YATI</span>
          <span class="col-kdv">KDV</span>
          <span class="col-tutar">TUTAR</span>
          <span class="col-stok">STOK</span>
        </div>
        <div class="cart-items" id="sepet-listesi"></div>
        <div class="bottom-panel" id="hizli-satis-panel"></div>
      </div>
    </div>
  </div>

  <!-- STOK MODÃœLÃœ -->
  <div id="stok-modulu" class="content-area">
    <div class="top-bar-satis">
      <span>Stok EkranÄ± - ÃœrÃ¼n Listesi ve YÃ¶netimi</span>
      <div class="toolbar">
        <button class="btn-outline" onclick="openStokView()"><i class="fa-solid fa-boxes-stacked"></i> &nbsp;StoklarÄ± GÃ¶rÃ¼ntÃ¼le</button>
      </div>
    </div>
    <div class="main-work-area" style="flex-direction:column; padding:20px;">
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
        <button class="modul-btn bg-green" style="width:200px; height:50px;" onclick="toggleUrunForm()"><i class="fa-solid fa-plus" style="margin-right:10px;"></i>Yeni ÃœrÃ¼n Ekle</button>
        <input id="stok-ara" placeholder="Barkod / ÃœrÃ¼n adÄ± ara" style="padding:10px; border:1px solid #ccc; border-radius:8px; width:280px;">
      </div>
      <div id="urun-form-panel" style="display:none; border:1px solid #ccc; padding:20px; background:#fff; margin-bottom:20px; border-radius:8px;">
        <h2>ÃœrÃ¼n Bilgileri</h2>
        <div style="display:flex; gap:30px;">
          <div style="flex:1;">
            <div class="input-group"><label for="form-barkod">Barkod No</label><input type="text" id="form-barkod" required></div>
            <div class="input-group"><label for="form-urunAd">ÃœrÃ¼n AdÄ±</label><input type="text" id="form-urunAd" required></div>
            <div class="input-group"><label for="form-satisFiyat">SatÄ±ÅŸ FiyatÄ±</label><input type="number" id="form-satisFiyat" step="0.01" required></div>
            <div class="input-group"><label for="form-alisFiyat">AlÄ±ÅŸ FiyatÄ±</label><input type="number" id="form-alisFiyat" step="0.01" required></div>
          </div>
          <div style="flex:1;">
            <div class="input-group"><label for="form-kdv">KDV %</label><input type="number" id="form-kdv" required></div>
            <div class="input-group"><label for="form-kategori">Kategori</label>
              <select id="form-kategori"><option>GÄ±da</option><option>Ä°Ã§ecek</option><option>Temizlik</option><option>TÃ¼tÃ¼n</option></select>
            </div>
            <div class="input-group"><label for="form-stokMiktar">Stok</label><input type="number" id="form-stokMiktar" required></div>
            <div class="input-group"><label for="form-birim">Birim</label><input type="text" id="form-birim" value="ADET"></div>
            <label style="display:flex; gap:8px; align-items:center; margin-top:8px;"><input id="form-quick" type="checkbox"> HÄ±zlÄ± satÄ±ÅŸ butonlarÄ±nda gÃ¶ster</label>
          </div>
        </div>
        <div style="margin-top:20px;">
          <button class="action-btn btn-sales" style="width:160px;" onclick="urunKaydet()">Kaydet/DÃ¼zenle</button>
          <button class="action-btn btn-lookup" style="width:120px; background:#dc3545" onclick="toggleUrunForm()">Ä°ptal</button>
        </div>
      </div>

      <h2>TanÄ±mlÄ± ÃœrÃ¼nler</h2>
      <table>
        <thead><tr><th>Barkod</th><th>ÃœrÃ¼n AdÄ±</th><th>SatÄ±ÅŸ</th><th>AlÄ±ÅŸ</th><th>Stok</th><th>KDV</th><th>Kategori</th><th>HÄ±zlÄ±</th><th></th></tr></thead>
        <tbody id="stok-tablo-govdesi"></tbody>
      </table>
    </div>
  </div>

  <!-- RAPOR MODÃœLÃœ -->
  <div id="rapor-modulu" class="content-area">
    <div class="top-bar-satis"><span>SatÄ±ÅŸ RaporlarÄ±</span></div>
    <div class="box">
      <div class="filters">
        <div><label>BaÅŸlangÄ±Ã§</label><input id="rp-from" type="date" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px"></div>
        <div><label>BitiÅŸ</label><input id="rp-to" type="date" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px"></div>
        <div><label>Kategori</label><input id="rp-cat" placeholder="(opsiyonel)" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px"></div>
        <div><label>Marka</label><input id="rp-brand" placeholder="(opsiyonel)" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px"></div>
        <div style="display:flex; align-items:flex-end;"><button class="action-btn btn-sales" style="width:100%" onclick="runReport()"><i class="fa-solid fa-magnifying-glass-chart"></i> Raporla [F5]</button></div>
        <div style="display:flex; align-items:flex-end; justify-content:flex-end; padding-bottom:4px;">
          <button class="action-btn btn-lookup" style="width:100%" onclick="exportReport()"><i class="fa-solid fa-file-export"></i> CSV DÄ±ÅŸa Aktar</button>
        </div>
      </div>
      <div style="max-height:52vh; overflow:auto;">
        <table>
          <thead><tr>
            <th>FiÅŸ No</th><th>Barkod</th><th>ÃœrÃ¼n</th><th>Miktar</th><th>SatÄ±ÅŸ ZamanÄ±</th>
            <th>AlÄ±ÅŸ</th><th>SatÄ±ÅŸ</th><th>Tutar</th><th>KÃ¢r</th><th>SatÄ±ÅŸ TÃ¼rÃ¼</th>
          </tr></thead>
          <tbody id="rp-rows"></tbody>
        </table>
      </div>
      <div class="totals">
        <div class="kpi"><b>SatÄ±ÅŸ Adedi</b><div id="rp-count">0</div></div>
        <div class="kpi"><b>ÃœrÃ¼n Toplam</b><div id="rp-total">0,00 â‚º</div></div>
        <div class="kpi"><b>AlÄ±ÅŸ Toplam</b><div id="rp-buy">0,00 â‚º</div></div>
        <div class="kpi"><b>KÃ¢r</b><div id="rp-profit">0,00 â‚º</div></div>
      </div>
      <div class="totals">
        <div class="kpi" style="background:#f8fff8"><b>ğŸ’µ Nakit SatÄ±ÅŸlar</b><div id="rp-cash">0,00 â‚º</div></div>
        <div class="kpi" style="background:#f8faff"><b>ğŸ’³ Kart SatÄ±ÅŸlar</b><div id="rp-card">0,00 â‚º</div></div>
        <div class="kpi" style="background:#fffaf8"><b>ğŸ§¾ Veresiye SatÄ±ÅŸlar</b><div id="rp-cari">0,00 â‚º</div></div>
        <div class="kpi" style="background:#f8f8ff"><b>ğŸ§® Toplam SatÄ±ÅŸlar</b><div id="rp-grand">0,00 â‚º</div></div>
      </div>
    </div>
  </div>

  <!-- VERESÄ°YE (ESKÄ° CARI) MODÃœLÃœ -->
  <div id="cari-modulu" class="content-area">
    <div class="top-bar-satis"><span>Veresiye Defteri</span></div>
    <div class="main-work-area" style="flex-direction:column; padding:20px;">
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
        <button class="action-btn btn-sales" style="width:230px;" onclick="musteriEkle()"><i class="fa-solid fa-user-plus"></i> Veresiye MÃ¼ÅŸterisi Ekle</button>
        <input id="cari-ara" placeholder="MÃ¼ÅŸteri ara (Kod / Ad Soyad)" style="padding:10px; border:1px solid #ccc; border-radius:8px; width:280px;">
      </div>
      <table>
        <thead><tr><th>Kod</th><th>AdÄ± SoyadÄ±</th><th>Telefon</th><th>Bakiye</th><th></th></tr></thead>
        <tbody id="cari-rows"></tbody>
      </table>
    </div>
  </div>

  <!-- ÃœRÃœN DÃœZENLE MODALI -->
  <div id="urun-modal" class="modal">
    <div class="panel">
      <h3>ÃœrÃ¼n DÃ¼zenle</h3>
      <div class="row"><label>Barkod</label><input id="md-barcode"></div>
      <div class="row"><label>ÃœrÃ¼n AdÄ±</label><input id="md-name"></div>
      <div class="row" style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px;">
        <div><label>SatÄ±ÅŸ</label><input id="md-price" type="number" step="0.01"></div>
        <div><label>AlÄ±ÅŸ</label><input id="md-buy" type="number" step="0.01"></div>
      </div>
      <div class="row" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">
        <div><label>Stok</label><input id="md-stock" type="number"></div>
        <div><label>KDV %</label><input id="md-vat" type="number"></div>
        <div style="display:flex; align-items:center; gap:8px; margin-top:16px;"><input id="md-quick" type="checkbox"> HÄ±zlÄ±</div>
      </div>
      <div class="right" style="margin-top:8px;">
        <button class="action-btn btn-lookup" style="width:120px; background:#6c757d" onclick="closeModal()">Ä°ptal</button>
        <button class="action-btn btn-sales" style="width:140px;" onclick="saveModal()">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- VERESÄ°YE HAREKET MODALI -->
  <div id="cari-modal" class="modal">
    <div class="panel">
      <h3 id="cari-modal-title">Veresiye Hareketleri</h3>
      <div class="table-like" id="cari-modal-body"></div>
      <div class="right" style="margin-top:10px;">
        <button class="btn-muted" onclick="closeCariModal()">Kapat</button>
      </div>
    </div>
  </div>

  <!-- STOK GÃ–RÃœNTÃœLE/DÃœZENLE MODALI -->
  <div id="stok-view-modal" class="modal">
    <div class="panel wide">
      <h3>GÃ¼ncel Stoklar</h3>
      <div style="display:flex; gap:10px; align-items:center; margin:10px 0;">
        <input id="sv-search" class="inline-input" placeholder="ÃœrÃ¼n adÄ± veya barkod ara">
        <div style="flex:1"></div>
        <button class="btn-save" onclick="saveStokView()">ğŸ’¾ Kaydet</button>
        <button class="btn-muted" onclick="closeStokView()">Kapat</button>
      </div>
      <div class="table-like" id="sv-table-wrap"></div>
    </div>
  </div>

  <!-- AYARLAR (YEDEKLEME + SIFIRLAMA) MODALI -->
  <div id="ayarlar-modal" class="modal">
    <div class="panel" style="width:620px;max-width:96vw;">
      <h3 class="settings-title"><i class="fa-solid fa-gear"></i> Sistem SÄ±fÄ±rlama ve BakÄ±m</h3>
      <div class="row-info">
        âš ï¸ Bu iÅŸlemler geri alÄ±namaz. YalnÄ±zca test verilerini veya hatalÄ± kayÄ±tlarÄ± silmek iÃ§in kullanÄ±n.
      </div>

      <h4 style="margin:14px 0 6px">1) Yedekleme Ä°ÅŸlemleri</h4>
      <div class="grid" style="margin-bottom:10px;">
        <button class="safe" onclick="settingsExport()">ğŸ’¾ Yedek Al (JSON)</button>
        <button class="btn-muted" onclick="settingsImport()">ğŸ“‚ Yedek YÃ¼kle (JSON)</button>
      </div>

      <h4 style="margin:14px 0 6px">2) Sistem SÄ±fÄ±rlama</h4>
      <div class="grid">
        <button class="warn" onclick="resetSales()">ğŸ§¾ RaporlarÄ± SÄ±fÄ±rla</button>
        <button class="warn" onclick="resetCustomers()">ğŸ‘¥ Veresiye (MÃ¼ÅŸteriler) SÄ±fÄ±rla</button>
        <button class="danger" onclick="factoryReset()">ğŸ­ Fabrika AyarlarÄ±na DÃ¶n</button>
      </div>

      <div class="right" style="margin-top:16px;">
        <button class="btn-muted" onclick="closeSettings()">Kapat</button>
      </div>
    </div>
  </div>

  <script>
    // === BASÄ°T VERÄ°TABANI (localStorage) ===
    const DBKEY = 'trendpos-harman-v1';
    const initial = {
      products: [
        { barcode:'1234567890', name:'5 L SÃœT', price:85, buy:60, vat:8, stock:50, category:'Ä°Ã§ecek', quick:true },
        { barcode:'1112223334', name:'POÅET TUTUN', price:60, buy:45, vat:18, stock:20, category:'TÃ¼tÃ¼n', quick:true },
        { barcode:'9876543210', name:'ÅÄ°ÅE SU', price:10, buy:4, vat:1, stock:200, category:'Ä°Ã§ecek', quick:true },
        { barcode:'5555555555', name:'POÄAÃ‡A SÄ°MÄ°T AÃ‡MA', price:7.5, buy:5, vat:8, stock:15, category:'GÄ±da', quick:true },
      ],
      sales: [], // {id,time,pay,customerId?,lines:[{barcode,name,qty,price,buy,vat}]}
      customers: [] // {id,code,name,phone,balance}
    };
    function load(){ return JSON.parse(localStorage.getItem(DBKEY)||'null') || initial; }
    function save(){ localStorage.setItem(DBKEY, JSON.stringify(db)); }
    let db = load();

    // YardÄ±mcÄ±lar
    const fmt = n => (n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2})+ ' â‚º';
    const qs = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>[...el.querySelectorAll(s)];
    const getCustomerById = id => db.customers.find(c=>String(c.id)===String(id));
    const clone = obj => JSON.parse(JSON.stringify(obj));

    // === NAV ===
    function showModule(name){ qsa('.content-area').forEach(e=>e.style.display='none'); qs('#'+name+'-modulu').style.display='flex';
      if(name==='stok') renderStock();
      if(name==='rapor') { setReportDefaults(); runReport(); }
      if(name==='cari') renderCari();
      if(name==='satis') { renderQuickButtons(); renderCart(); populateCustomerSelect(); setTimeout(()=>qs('#barkod-input')?.focus(),50); }
    }
    document.addEventListener('DOMContentLoaded', ()=>{ showModule('anasayfa'); renderQuickButtons(); populateCustomerSelect(); });

    // === SEPET ===
    let sepet = [];
    function addToCart(prod, qty=1){ const line = sepet.find(l=>l.barcode===prod.barcode); if(line) line.qty += qty; else sepet.push({ barcode:prod.barcode, name:prod.name, price:prod.price, buy:prod.buy||0, vat:prod.vat||0, stock:prod.stock||0, qty }); renderCart(); }
    function renderCart(){ const body = qs('#sepet-listesi'); if(!body) return; body.innerHTML=''; let total=0; sepet.forEach((l,idx)=>{ const t = l.qty*l.price*(1+(l.vat||0)/100); total += t; const row = document.createElement('div'); row.className='cart-row'; row.innerHTML = `<span class="col-urun">${l.name}</span><span class="col-miktar" style="text-align:center">${l.qty}</span><span class="col-bfiyat">${l.price.toFixed(2)}</span><span class="col-kdv" style="text-align:center">${l.vat||0}%</span><span class="col-tutar">${t.toFixed(2)}</span><span class="col-stok" style="color:green;">${l.stock}</span>`; row.addEventListener('dblclick',()=>openEditByBarcode(l.barcode)); row.addEventListener('click',()=>{ if(confirm('SatÄ±r silinsin mi?')){ sepet.splice(idx,1); renderCart(); }}); body.appendChild(row); }); qs('#genel-toplam').textContent = fmt(total); }

    function findProductBy(codeOrName){ return db.products.find(p=>p.barcode===codeOrName) || db.products.find(p=>p.name.toLowerCase()===codeOrName.toLowerCase()); }
    function urunEkle(code){ const p = findProductBy(code); if(!p){ alert('ÃœrÃ¼n bulunamadÄ±: '+code); return; } addToCart(p,1); qs('#barkod-input').value=''; qs('#barkod-input').focus(); }
    function handleBarcodeEnter(e){ if(e.key==='Enter'){ urunEkle(qs('#barkod-input').value.trim()); } }

    function satisYap(){
      if(sepet.length===0){ alert('Sepet boÅŸ.'); return; }
      const pay = (qs('input[name="odeme"]:checked')||{}).value||'nakit';
      let selectedCustomerId = null;
      if(pay==='cari'){
        selectedCustomerId = qs('#musteri-select').value || '';
        if(!selectedCustomerId){ alert('Veresiye satÄ±ÅŸ iÃ§in mÃ¼ÅŸteri seÃ§iniz.'); return; }
      }
      const id=(db.sales.at(-1)?.id||47220)+1;
      const time=new Date().toISOString();
      const lines = sepet.map(x=>({...x}));
      lines.forEach(l=>{ const p=db.products.find(pp=>pp.barcode===l.barcode); if(p) p.stock = (p.stock||0)-l.qty; });

      const sale = {id,time,pay,lines};
      if(pay==='cari') sale.customerId = selectedCustomerId;

      db.sales.push(sale);

      if(pay==='cari'){
        const c = getCustomerById(selectedCustomerId);
        if(c){
          const tutar = lines.reduce((s,l)=> s+l.qty*l.price*(1+(l.vat||0)/100),0);
          c.balance = (c.balance||0) + tutar;
        }
      }

      save();
      sepet=[]; renderCart(); renderStock();
      alert('SatÄ±ÅŸ tamamlandÄ±. FiÅŸ No: '+id);
    }

    function iadeIslemi(){ alert('Ä°ade modÃ¼lÃ¼ demo.'); }
    function indirimUygula(){ const p = Number(prompt('Sepet toplam yÃ¼zde indirim (%)?','0')||'0'); if(!p) return; sepet.forEach(l=> l.price = Number((l.price*(1-p/100)).toFixed(2))); renderCart(); }
    function fiyatGor(){ const code = prompt('Barkod veya ad:'); if(!code) return; const p = findProductBy(code.trim()); if(!p) return alert('BulunamadÄ±'); alert(`${p.name}\nSatÄ±ÅŸ: ${fmt(p.price)}\nStok: ${p.stock}`); }

    // === HIZLI BUTONLAR ===
    function renderQuickButtons(){
      const panel = qs('#hizli-satis-panel');
      if(!panel) return;
      panel.innerHTML = '';
      db.products.filter(p=>p.quick).forEach(p=>{
        const btn = document.createElement('button');
        btn.className = 'quick-sale-btn';
        btn.textContent = p.name;
        btn.onclick = ()=> urunEkle(p.barcode);
        panel.appendChild(btn);
      });
    }

    // === ÃœRÃœN DÃœZENLE (modal) ===
    let modalProduct = null;
    function openEditByBarcode(code){ const p = db.products.find(x=>x.barcode===code); if(!p) return; modalProduct = p; qs('#md-barcode').value=p.barcode; qs('#md-name').value=p.name; qs('#md-price').value=p.price; qs('#md-buy').value=p.buy||0; qs('#md-stock').value=p.stock||0; qs('#md-vat').value=p.vat||0; qs('#md-quick').checked=!!p.quick; qs('#urun-modal').style.display='flex'; }
    function closeModal(){ qs('#urun-modal').style.display='none'; }
    function saveModal(){ if(!modalProduct) return; Object.assign(modalProduct, { barcode:qs('#md-barcode').value.trim()||modalProduct.barcode, name:qs('#md-name').value.trim()||modalProduct.name, price:Number(qs('#md-price').value)||0, buy:Number(qs('#md-buy').value)||0, stock:Number(qs('#md-stock').value)||0, vat:Number(qs('#md-vat').value)||0, quick:qs('#md-quick').checked }); save(); closeModal(); renderStock(); renderCart(); renderQuickButtons(); }

    // === STOK ===
    let currentEditBarkod = null;
    function toggleUrunForm(){ const p = qs('#urun-form-panel'); p.style.display = (p.style.display==='none'||!p.style.display)?'block':'none'; if(p.style.display==='none'){ ['#form-barkod','#form-urunAd','#form-satisFiyat','#form-alisFiyat','#form-kdv','#form-stokMiktar','#form-birim'].forEach(s=>qs(s).value=''); qs('#form-quick').checked=false; currentEditBarkod=null; } }
    function urunKaydet(){ const barkod=qs('#form-barkod').value.trim(); const ad=qs('#form-urunAd').value.trim(); const fiyat=parseFloat(qs('#form-satisFiyat').value); const alis=parseFloat(qs('#form-alisFiyat').value); const kdv=parseInt(qs('#form-kdv').value); const stok=parseInt(qs('#form-stokMiktar').value); const kategori=qs('#form-kategori').value; const quick=qs('#form-quick').checked; if(!barkod||!ad||isNaN(fiyat)||isNaN(alis)||isNaN(kdv)||isNaN(stok)){ alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun'); return; } const yeni = { barcode:barkod, name:ad, price:fiyat, buy:alis, vat:kdv, stock:stok, category:kategori, quick}; const idx = db.products.findIndex(u=>u.barcode===barkod);
      if(currentEditBarkod && currentEditBarkod===barkod){ db.products[idx]=yeni; alert('ÃœrÃ¼n gÃ¼ncellendi'); }
      else if(idx!==-1){ alert('Bu barkod zaten var'); return; }
      else { db.products.push(yeni); alert('ÃœrÃ¼n eklendi'); }
      save(); toggleUrunForm(); renderStock(); renderQuickButtons(); }
    function urunuDuzenle(barkod){ const u = db.products.find(p=>p.barcode===barkod); if(!u) return; qs('#form-barkod').value=u.barcode; qs('#form-urunAd').value=u.name; qs('#form-satisFiyat').value=u.price; qs('#form-alisFiyat').value=u.buy||0; qs('#form-kdv').value=u.vat||0; qs('#form-stokMiktar').value=u.stock||0; qs('#form-kategori').value=u.category||'GÄ±da'; qs('#form-quick').checked=!!u.quick; currentEditBarkod=barkod; if(qs('#urun-form-panel').style.display!=='block') toggleUrunForm(); }
    function renderStock(){ const term=(qs('#stok-ara')?.value||'').toLowerCase(); const body=qs('#stok-tablo-govdesi'); if(!body) return; body.innerHTML=''; db.products.filter(u=>!term||u.barcode.includes(term)||u.name.toLowerCase().includes(term)).forEach(u=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${u.barcode}</td><td>${u.name}</td><td>${fmt(u.price)}</td><td>${u.buy?fmt(u.buy):'â€”'}</td><td>${u.stock}</td><td>${u.vat}%</td><td>${u.category||''}</td><td>${u.quick?'âœ…':''}</td><td><button onclick="urunuDuzenle('${u.barcode}')" style="background:#007bff;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">DÃ¼zenle</button> <button onclick="stokSil('${u.barcode}')" style="background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">Sil</button></td>`; body.appendChild(tr); }); }
    function stokSil(code){ if(!confirm('Silinsin mi?')) return; db.products = db.products.filter(p=>p.barcode!==code); save(); renderStock(); renderQuickButtons(); }
    qs('#stok-ara')?.addEventListener('input', renderStock);

    // === RAPORLAR ===
    function setReportDefaults(){ const d=new Date(); const y=d.toISOString().slice(0,10); qs('#rp-from').value=y; qs('#rp-to').value=y; qs('#rp-cat').value=''; qs('#rp-brand').value=''; }
    function runReport(){
      const from=new Date(qs('#rp-from').value||'1970-01-01');
      const to=new Date(qs('#rp-to').value||new Date());
      to.setHours(23,59,59,999);
      const cat=(qs('#rp-cat').value||'').toLowerCase();
      const brand=(qs('#rp-brand').value||'').toLowerCase();
      const rows=[];
      db.sales.forEach(s=>{
        const t=new Date(s.time);
        if(t<from||t>to) return;
        s.lines.forEach(l=>{
          const prod = db.products.find(p=>p.barcode===l.barcode) || l;
          if(cat && (prod.category||'').toLowerCase().indexOf(cat)===-1) return;
          if(brand && (prod.brand||'').toLowerCase().indexOf(brand)===-1) return;
          const buy=Number(l.buy||0);
          const total=l.qty*l.price*(1+(l.vat||0)/100);
          const profit=l.qty*(l.price-buy);
          rows.push({ id:s.id, barcode:l.barcode, name:l.name, qty:l.qty, time:s.time, buy, price:l.price, total, profit, pay:s.pay });
        });
      });
      const body=qs('#rp-rows'); body.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${r.id}</td>
          <td>${r.barcode}</td>
          <td>${r.name}</td>
          <td>${r.qty}</td>
          <td>${new Date(r.time).toLocaleString('tr-TR')}</td>
          <td>${fmt(r.buy)}</td>
          <td>${fmt(r.price)}</td>
          <td>${fmt(r.total)}</td>
          <td>${fmt(r.profit)}</td>
          <td>${r.pay==='cari' ? 'VERESÄ°YE' : (r.pay||'').toUpperCase()}</td>`;
        body.appendChild(tr);
      });

      const sum = k => rows.reduce((s,x)=>s+Number(x[k]||0),0);
      qs('#rp-count').textContent=rows.length;
      qs('#rp-total').textContent=fmt(sum('total'));
      qs('#rp-buy').textContent=fmt(sum('buy'));
      qs('#rp-profit').textContent=fmt(sum('profit'));

      const totalByPay = type => rows.filter(x=>x.pay===type).reduce((s,x)=>s+x.total,0);
      const nakit = totalByPay('nakit');
      const kart  = totalByPay('kart');
      const cari  = totalByPay('cari');
      qs('#rp-cash').textContent=fmt(nakit);
      qs('#rp-card').textContent=fmt(kart);
      qs('#rp-cari').textContent=fmt(cari);
      qs('#rp-grand').textContent=fmt(nakit+kart+cari);
    }
    function exportReport(){
      const body=qs('#rp-rows');
      if(!body||!body.children.length) return alert('Ã–nce rapor oluÅŸturun');
      let csv='fis_no,barkod,urun,adet,satis_zamani,alis,satis,tutar,kar\n';
      db.sales.forEach(s=>{
        s.lines.forEach(l=>{
          csv += `${s.id},${l.barcode},"${l.name}",${l.qty},${new Date(s.time).toLocaleString('tr-TR')},${l.buy||0},${l.price},${l.qty*l.price},${l.qty*(l.price-(l.buy||0))}\n`;
        });
      });
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rapor.csv'; a.click();
    }

    // === VERESÄ°YE (CARI) ===
    function populateCustomerSelect(){
      const sel = qs('#musteri-select');
      if(!sel) return;
      const current = sel.value;
      sel.innerHTML = `<option value="">Perakende SatÄ±ÅŸ</option>` + db.customers.map(c=>`<option value="${c.id}">${c.code ? c.code+' - ' : ''}${c.name}</option>`).join('');
      const hasPrev = [...sel.options].some(o=>o.value===current);
      sel.value = hasPrev ? current : '';
    }

    function renderCari(){
      const term=(qs('#cari-ara')?.value||'').toLowerCase();
      const body=qs('#cari-rows'); if(!body) return;
      body.innerHTML='';
      db.customers
        .filter(c=>!term || (c.code||'').toLowerCase().includes(term) || (c.name||'').toLowerCase().includes(term))
        .forEach(c=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${c.code||''}</td><td>${c.name||''}</td><td>${c.phone||''}</td><td>${fmt(c.balance||0)}</td>
          <td>
            <button onclick="tahsilat('${c.id}')" style="background:#007bff;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">Tahsil Et</button>
            <button onclick="cariGoster('${c.id}')" style="background:#6c757d;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin-left:6px;">Veresiye GeÃ§miÅŸi</button>
          </td>`;
          body.appendChild(tr);
        });
    }
    qs('#cari-ara')?.addEventListener('input', renderCari);

    function musteriEkle(){
      const code = prompt('MÃ¼ÅŸteri Kodu? (Ã¶r. C0001)');
      if(code===null) return;
      if(!code.trim()) return alert('MÃ¼ÅŸteri kodu gerekli');
      if(db.customers.some(c=>String(c.code||'').toLowerCase()===code.trim().toLowerCase())){ alert('Bu mÃ¼ÅŸteri kodu zaten var.'); return; }

      const name = prompt('AdÄ± SoyadÄ±?');
      if(name===null) return;
      if(!name.trim()) return alert('AdÄ± SoyadÄ± gerekli');

      const phone = prompt('Telefon (opsiyonel)') || '';

      const id = String(Date.now());
      db.customers.push({id, code:code.trim(), name:name.trim(), phone, balance:0});
      save();
      renderCari();
      populateCustomerSelect();
      alert('MÃ¼ÅŸteri eklendi.');
    }

    function tahsilat(id){
      const c=getCustomerById(id); if(!c) return;
      const val=Number(prompt('Tahsil tutarÄ±?', c.balance||0)||0);
      c.balance=(c.balance||0)-val;
      if(c.balance<0) c.balance=0;
      save(); renderCari();
    }

    function cariGoster(id){
      const c=getCustomerById(id); if(!c) return;
      const title = `${c.code ? c.code+' - ' : ''}${c.name} â€¢ Veresiye SatÄ±n AlÄ±mlar`;
      qs('#cari-modal-title').textContent = title;

      const rows = [];
      db.sales.forEach(s=>{
        if(s.pay==='cari' && String(s.customerId||'')===String(id)){
          s.lines.forEach(l=>{
            rows.push({
              time: new Date(s.time).toLocaleString('tr-TR'),
              fis: s.id,
              barkod: l.barcode,
              urun: l.name,
              adet: l.qty,
              fiyat: l.price,
              tutar: l.qty * l.price * (1 + (l.vat||0)/100)
            });
          });
        }
      });

      let html = `<div class="table-like"><table>
        <thead><tr><th>Tarih/Saat</th><th>FiÅŸ No</th><th>Barkod</th><th>ÃœrÃ¼n</th><th>Adet</th><th>B.Fiyat</th><th>Tutar</th></tr></thead><tbody>`;

      if(rows.length===0){
        html += `<tr><td colspan="7" style="text-align:center;color:#666">KayÄ±t yok</td></tr>`;
      } else {
        rows.sort((a,b)=> a.time.localeCompare(b.time));
        rows.forEach(r=>{
          html += `<tr>
            <td>${r.time}</td><td>${r.fis}</td><td>${r.barkod}</td><td>${r.urun}</td>
            <td>${r.adet}</td><td>${r.fiyat.toFixed(2)}</td><td>${r.tutar.toFixed(2)}</td>
          </tr>`;
        });
      }
      html += `</tbody></table></div>`;
      qs('#cari-modal-body').innerHTML = html;
      qs('#cari-modal').style.display='flex';
    }
    function closeCariModal(){ qs('#cari-modal').style.display='none'; }

    // === STOK GÃ–RÃœNTÃœLE (MODAL) ===
    let stokViewBuffer = [];
    function openStokView(){
      stokViewBuffer = db.products.map(p=>({...p})); // Ã§alÄ±ÅŸma kopyasÄ±
      qs('#sv-search').value = '';
      renderStokViewTable('');
      qs('#stok-view-modal').style.display='flex';
      setTimeout(()=>qs('#sv-search').focus(),50);
    }
    function closeStokView(){ qs('#stok-view-modal').style.display='none'; }

    function renderStokViewTable(term){
      term = (term||'').toLowerCase();
      const rows = stokViewBuffer
        .filter(p=> !term || p.barcode.includes(term) || (p.name||'').toLowerCase().includes(term))
        .sort((a,b)=> (a.name||'').localeCompare(b.name||'tr'));
      let html = `<table>
        <thead><tr>
          <th>Barkod</th><th>ÃœrÃ¼n AdÄ±</th><th>Kategori</th>
          <th style="width:110px">Stok</th>
          <th style="width:140px">SatÄ±ÅŸ FiyatÄ±</th>
          <th style="width:140px">AlÄ±ÅŸ FiyatÄ±</th>
          <th style="width:90px">KDV %</th>
          <th style="width:80px">HÄ±zlÄ±</th>
        </tr></thead><tbody>`;
      if(rows.length===0){
        html += `<tr><td colspan="8" style="text-align:center;color:#666">KayÄ±t bulunamadÄ±</td></tr>`;
      } else {
        rows.forEach((p)=>{
          html += `<tr>
            <td>${p.barcode}</td>
            <td><input class="inline-input" value="${p.name||''}" oninput="svEdit('${p.barcode}','name',this.value)"></td>
            <td><input class="inline-input" value="${p.category||''}" oninput="svEdit('${p.barcode}','category',this.value)"></td>
            <td><input class="inline-input" type="number" step="1" value="${Number(p.stock||0)}" oninput="svNumber('${p.barcode}','stock',this.value)"></td>
            <td><input class="inline-input" type="number" step="0.01" value="${Number(p.price||0)}" oninput="svNumber('${p.barcode}','price',this.value)"></td>
            <td><input class="inline-input" type="number" step="0.01" value="${Number(p.buy||0)}" oninput="svNumber('${p.barcode}','buy',this.value)"></td>
            <td><input class="inline-input" type="number" step="1" value="${Number(p.vat||0)}" oninput="svNumber('${p.barcode}','vat',this.value)"></td>
            <td style="text-align:center">
              <input type="checkbox" ${p.quick?'checked':''} onchange="svEdit('${p.barcode}','quick',this.checked)">
            </td>
          </tr>`;
        });
      }
      html += `</tbody></table>`;
      qs('#sv-table-wrap').innerHTML = html;
    }

    function svEdit(barcode, field, value){
      const i = stokViewBuffer.findIndex(x=>x.barcode===barcode);
      if(i>-1){
        stokViewBuffer[i][field] = value;
      }
    }
    function svNumber(barcode, field, value){
      const num = value==='' ? 0 : Number(value);
      if(isNaN(num)) return; // geÃ§ersizse yoksay
      svEdit(barcode, field, num);
    }

    function saveStokView(){
      stokViewBuffer.forEach(buf=>{
        const i = db.products.findIndex(p=>p.barcode===buf.barcode);
        if(i>-1){
          db.products[i] = {
            ...db.products[i],
            name: buf.name||'',
            category: buf.category||'',
            stock: Number(buf.stock||0),
            price: Number(buf.price||0),
            buy: Number(buf.buy||0),
            vat: Number(buf.vat||0),
            quick: !!buf.quick
          };
        }
      });
      save();
      renderStock();
      renderQuickButtons();
      alert('Stok deÄŸiÅŸiklikleri kaydedildi.');
    }

    // Arama
    qs('#sv-search')?.addEventListener('input', (e)=> renderStokViewTable(e.target.value));

    // === AYARLAR MODALI ===
    function openSettings(){ qs('#ayarlar-modal').style.display='flex'; }
    function closeSettings(){ qs('#ayarlar-modal').style.display='none'; }

    function settingsExport(){ document.getElementById('lnk-export').click(); }
    function settingsImport(){ document.getElementById('lnk-import').click(); }

    function resetSales(){
      if(!confirm('TÃ¼m satÄ±ÅŸ kayÄ±tlarÄ±nÄ± (raporlarÄ±) sÄ±fÄ±rlamak istediÄŸinize emin misiniz?')) return;
      db.sales = [];
      save();
      setReportDefaults(); runReport();
      alert('Raporlar sÄ±fÄ±rlandÄ±.');
      closeSettings(); showModule('anasayfa');
    }

    function resetCustomers(){
      if(!confirm('TÃ¼m veresiye mÃ¼ÅŸterilerini sÄ±fÄ±rlamak istediÄŸinize emin misiniz?')) return;
      db.customers = [];
      save();
      renderCari(); populateCustomerSelect();
      alert('Veresiye mÃ¼ÅŸterileri sÄ±fÄ±rlandÄ±.');
      closeSettings(); showModule('anasayfa');
    }

    function factoryReset(){
      if(!confirm('TÃ¼m sistemi fabrika ayarlarÄ±na dÃ¶ndÃ¼rmek istiyor musunuz? (ÃœrÃ¼nler, satÄ±ÅŸlar, veresiye kayÄ±tlarÄ±)')) return;
      db = clone(initial);
      save();
      renderStock(); renderCari(); populateCustomerSelect(); renderQuickButtons(); setReportDefaults(); runReport();
      alert('Sistem fabrika ayarlarÄ±na dÃ¶ndÃ¼rÃ¼ldÃ¼.');
      closeSettings(); showModule('anasayfa');
    }

    // === YEDEKLEME (Ã¼st menÃ¼) ===
    qs('#lnk-export').addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='yucel-bakkal-yedek.json'; a.click();
    });
    qs('#lnk-import').addEventListener('click', ()=> qs('#file-import').click());
    qs('#file-import').addEventListener('change', (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          db=JSON.parse(r.result);
          save();
          alert('Yedek iÃ§e aktarÄ±ldÄ±');
          showModule('stok'); populateCustomerSelect(); renderCari(); renderStock(); renderQuickButtons(); setReportDefaults(); runReport();
          closeSettings();
        }catch{
          alert('GeÃ§ersiz dosya');
        }
      };
      r.readAsText(f);
      e.target.value='';
    });

    // === KISAYOLLAR ===
    document.addEventListener('keydown', (e)=>{
      if(e.key==='F1'){ e.preventDefault(); if(qs('#satis-modulu').style.display!=='none') satisYap(); else showModule('satis'); }
      if(e.key==='F2'){ e.preventDefault(); showModule('stok'); }
      if(e.key==='F3'){ e.preventDefault(); showModule('rapor'); }
      if(e.key==='F4'){ e.preventDefault(); showModule('cari'); }
      if(e.key==='F5'){ e.preventDefault(); runReport(); }
      if(e.key==='Escape'){
        ['urun-modal','cari-modal','stok-view-modal','ayarlar-modal'].forEach(id=>{
          const el=qs('#'+id);
          if(el && el.style.display==='flex') el.style.display='none';
        });
      }
    });
  </script>
</body>
</html>
